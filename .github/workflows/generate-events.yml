name: Generate Game Events with LLM

on:
  schedule:
    # æ¯24å°æ—¶è¿è¡Œä¸€æ¬¡ (UTCæ—¶é—´æ¯å¤©å‡Œæ™¨2ç‚¹)
    - cron: '0 2 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      event_count:
        description: 'ç”Ÿæˆäº‹ä»¶æ•°é‡'
        required: false
        default: '400'
        type: string

jobs:
  generate-events:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'api/package.json'
    
    - name: Install dependencies
      run: |
        cd api
        npm install
    
    - name: Generate events with DeepSeek
      env:
        DEEPSEEK_TOKEN: ${{ secrets.DEEPSEEK_TOKEN }}
        EVENT_COUNT: ${{ github.event.inputs.event_count || '400' }}
      run: |
        cd api
        node -e "
        const handler = require('./generate-events.js').default;
        const req = { method: 'POST', body: { eventCount: process.env.EVENT_COUNT } };
        const res = {
          status: (code) => ({ json: (data) => console.log(JSON.stringify(data, null, 2)) }),
          json: (data) => console.log(JSON.stringify(data, null, 2))
        };
        handler(req, res).catch(console.error);
        "
    
    - name: Commit and push new events
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        git add -A
        if git diff --staged --quiet; then
          echo "No new events generated"
        else
          git commit -m "ðŸŽ² Auto-generate ${{ github.event.inputs.event_count || '400' }} new game events [$(date +'%Y-%m-%d %H:%M:%S UTC')]

          - Generated events for all storylines
          - Total events: ${{ github.event.inputs.event_count || '400' }}
          - Timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')
          - Trigger: ${{ github.event_name }}"
          git push
        fi
    
    - name: Deploy to Vercel (if configured)
      if: ${{ secrets.VERCEL_TOKEN }}
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        working-directory: ./
    
    - name: Create summary
      run: |
        echo "## ðŸŽ² äº‹ä»¶ç”Ÿæˆå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **ç”Ÿæˆæ•°é‡**: ${{ github.event.inputs.event_count || '400' }} ä¸ªäº‹ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "- **ç”Ÿæˆæ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å‰§æƒ…ç±»åž‹**: ä»™ä¾ ä¿®çœŸã€çŽ„å¹»å¥‡ç¼˜ã€ç§‘å¹»æœªæ¥ã€æ­¦ä¾ æ±Ÿæ¹–ã€è¥¿å¹»å†’é™©" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š ç»Ÿè®¡ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- æ¯ä¸ªå‰§æƒ…ç±»åž‹çº¦ç”Ÿæˆ 80 ä¸ªäº‹ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "- æ‰€æœ‰äº‹ä»¶å‡ä¸ºçº¯æ•…äº‹æ€§ï¼Œä¸å½±å“è§’è‰²æ•°å€¼" >> $GITHUB_STEP_SUMMARY
        echo "- äº‹ä»¶å·²è‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“" >> $GITHUB_STEP_SUMMARY
