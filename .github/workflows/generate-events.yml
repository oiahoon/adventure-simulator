name: Generate Game Events with LLM

on:
  schedule:
    # 每24小时运行一次 (UTC时间每天凌晨2点)
    - cron: '0 2 * * *'
  workflow_dispatch: # 允许手动触发
    inputs:
      event_count:
        description: '生成事件数量'
        required: false
        default: '400'
        type: string

jobs:
  generate-events:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'scripts/event-generator/package.json'
    
    - name: Install dependencies
      run: |
        cd scripts/event-generator
        npm install
    
    - name: Generate events with DeepSeek
      env:
        DEEPSEEK_TOKEN: ${{ secrets.DEEPSEEK_TOKEN }}
        EVENT_COUNT: ${{ github.event.inputs.event_count || '400' }}
      run: |
        cd scripts/event-generator
        node generate-events.js
    
    - name: Commit and push new events
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        git add src/data/generated-events.json
        git add src/data/event-stats.json
        if git diff --staged --quiet; then
          echo "No new events generated"
        else
          git commit -m "🎲 Auto-generate ${{ github.event.inputs.event_count || '400' }} new game events [$(date +'%Y-%m-%d %H:%M:%S UTC')]

          - Generated events for all storylines
          - Total events: ${{ github.event.inputs.event_count || '400' }}
          - Timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')
          - Trigger: ${{ github.event_name }}"
          git push
        fi
    
    - name: Create summary
      run: |
        echo "## 🎲 事件生成完成" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **生成数量**: ${{ github.event.inputs.event_count || '400' }} 个事件" >> $GITHUB_STEP_SUMMARY
        echo "- **生成时间**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **触发方式**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **剧情类型**: 仙侠修真、玄幻奇缘、科幻未来、武侠江湖、西幻冒险" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📊 统计信息" >> $GITHUB_STEP_SUMMARY
        echo "- 每个剧情类型约生成 80 个事件" >> $GITHUB_STEP_SUMMARY
        echo "- 事件支持纯故事和影响两种类型" >> $GITHUB_STEP_SUMMARY
        echo "- 事件已保存到 JSON 数据库文件" >> $GITHUB_STEP_SUMMARY
