name: Generate Game Events with LLM

on:
  schedule:
    # 每24小时运行一次 (UTC时间每天凌晨2点)
    - cron: '0 2 * * *'
  workflow_dispatch: # 允许手动触发
    inputs:
      event_count:
        description: '生成事件数量'
        required: false
        default: '400'
        type: string

jobs:
  generate-events:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'api/package.json'
    
    - name: Install dependencies
      run: |
        cd api
        npm install
    
    - name: Generate events with DeepSeek
      env:
        DEEPSEEK_TOKEN: ${{ secrets.DEEPSEEK_TOKEN }}
        EVENT_COUNT: ${{ github.event.inputs.event_count || '400' }}
      run: |
        cd api
        node -e "
        const handler = require('./generate-events.js').default;
        const req = { method: 'POST', body: { eventCount: process.env.EVENT_COUNT } };
        const res = {
          status: (code) => ({ json: (data) => console.log(JSON.stringify(data, null, 2)) }),
          json: (data) => console.log(JSON.stringify(data, null, 2))
        };
        handler(req, res).catch(console.error);
        "
    
    - name: Commit and push new events
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        git add -A
        if git diff --staged --quiet; then
          echo "No new events generated"
        else
          git commit -m "🎲 Auto-generate ${{ github.event.inputs.event_count || '400' }} new game events [$(date +'%Y-%m-%d %H:%M:%S UTC')]

          - Generated events for all storylines
          - Total events: ${{ github.event.inputs.event_count || '400' }}
          - Timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')
          - Trigger: ${{ github.event_name }}"
          git push
        fi
    
    - name: Deploy to Vercel (if configured)
      if: ${{ secrets.VERCEL_TOKEN }}
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        working-directory: ./
    
    - name: Create summary
      run: |
        echo "## 🎲 事件生成完成" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **生成数量**: ${{ github.event.inputs.event_count || '400' }} 个事件" >> $GITHUB_STEP_SUMMARY
        echo "- **生成时间**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **触发方式**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **剧情类型**: 仙侠修真、玄幻奇缘、科幻未来、武侠江湖、西幻冒险" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📊 统计信息" >> $GITHUB_STEP_SUMMARY
        echo "- 每个剧情类型约生成 80 个事件" >> $GITHUB_STEP_SUMMARY
        echo "- 所有事件均为纯故事性，不影响角色数值" >> $GITHUB_STEP_SUMMARY
        echo "- 事件已自动保存到数据库" >> $GITHUB_STEP_SUMMARY
