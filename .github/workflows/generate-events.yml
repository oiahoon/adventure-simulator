name: LLM Story & Plot Generation Factory

on:
  schedule:
    # æ¯12å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ŒæŒç»­ç”Ÿæˆæ–°å‰§æƒ…
    - cron: '0 */12 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      story_count:
        description: 'ç”Ÿæˆæ•…äº‹æ•°é‡'
        required: false
        default: '50'
        type: string
      plot_complexity:
        description: 'å‰§æƒ…å¤æ‚åº¦'
        required: false
        default: 'medium'
        type: choice
        options:
        - simple
        - medium
        - complex
        - epic
      story_themes:
        description: 'æ•…äº‹ä¸»é¢˜ (é€—å·åˆ†éš”)'
        required: false
        default: 'martial_arts,sect_politics,romance,revenge,mystery'
        type: string

jobs:
  generate-llm-stories:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    strategy:
      matrix:
        story_type: 
          - main_quest      # ä¸»çº¿å‰§æƒ…
          - side_quest      # æ”¯çº¿ä»»åŠ¡
          - npc_stories     # NPCèƒŒæ™¯æ•…äº‹
          - sect_events     # é—¨æ´¾äº‹ä»¶
          - romance_plots   # æƒ…æ„Ÿå‰§æƒ…
          - mystery_cases   # æ‚¬ç–‘æ¡ˆä»¶
          - martial_legends # æ­¦åŠŸä¼ è¯´
          - world_events    # ä¸–ç•Œå¤§äº‹ä»¶
    
    steps:
    - name: ğŸ® Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: ğŸ Setup Python Environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸ“¦ Install Dependencies
      run: |
        pip install --upgrade pip
        pip install requests python-dotenv openai anthropic google-generativeai
        pip install sqlite3 json5 pyyaml markdown beautifulsoup4

    - name: ğŸ¤– Generate LLM Stories - ${{ matrix.story_type }}
      env:
        DEEPSEEK_TOKEN: ${{ secrets.DEEPSEEK_TOKEN }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        STORY_COUNT: ${{ github.event.inputs.story_count || '50' }}
        PLOT_COMPLEXITY: ${{ github.event.inputs.plot_complexity || 'medium' }}
        STORY_THEMES: ${{ github.event.inputs.story_themes || 'martial_arts,sect_politics,romance,revenge,mystery' }}
        STORY_TYPE: ${{ matrix.story_type }}
      run: |
        python scripts/llm_story_generator.py \
          --story-type "$STORY_TYPE" \
          --count "$STORY_COUNT" \
          --complexity "$PLOT_COMPLEXITY" \
          --themes "$STORY_THEMES" \
          --output-format "json,markdown,sqlite"

    - name: ğŸ“Š Generate Story Analytics
      run: |
        python scripts/story_analytics.py \
          --analyze-generated \
          --create-reports \
          --update-metrics

    - name: ğŸ­ Create Story Connections
      run: |
        python scripts/story_connector.py \
          --link-characters \
          --create-plot-threads \
          --build-story-graph

    - name: ğŸ“š Update Story Database
      run: |
        python scripts/update_story_database.py \
          --merge-new-stories \
          --update-indexes \
          --optimize-queries

    - name: ğŸ¨ Generate Story Assets
      run: |
        python scripts/story_assets_generator.py \
          --create-character-portraits \
          --generate-location-descriptions \
          --create-item-descriptions

    - name: ğŸ“ Create Story Documentation
      run: |
        python scripts/story_documentation.py \
          --create-story-wiki \
          --generate-character-sheets \
          --create-timeline

    - name: ğŸ” Quality Assurance Check
      run: |
        python scripts/story_qa.py \
          --check-consistency \
          --validate-characters \
          --verify-plot-logic \
          --test-story-flow

    - name: ğŸ“¤ Commit Generated Stories
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "LLM Story Generator"
        
        # Add all generated content
        git add frontend/src/data/stories/
        git add frontend/src/data/characters/
        git add frontend/src/data/plots/
        git add docs/stories/
        
        # Create detailed commit message
        STORY_COUNT=$(find frontend/src/data/stories/ -name "*.json" -newer .git/COMMIT_EDITMSG 2>/dev/null | wc -l || echo "0")
        
        git commit -m "ğŸ® Auto-generate ${{ matrix.story_type }} stories via LLM

        ğŸ“Š Generation Summary:
        - Story Type: ${{ matrix.story_type }}
        - Stories Generated: ${STORY_COUNT}
        - Complexity: ${{ github.event.inputs.plot_complexity || 'medium' }}
        - Themes: ${{ github.event.inputs.story_themes || 'martial_arts,sect_politics,romance,revenge,mystery' }}
        
        ğŸ¤– LLM Providers Used:
        - DeepSeek (Primary)
        - OpenAI (Backup)
        - Anthropic (Quality Check)
        
        ğŸ“š Generated Content:
        - Complete story plots and narratives
        - Character backgrounds and relationships
        - Dialogue and interactions
        - World-building elements
        - Quest objectives and rewards
        
        ğŸ¯ Story Features:
        - Multi-layered plot development
        - Character arc progression
        - Interconnected storylines
        - Cultural authenticity (æ­¦ä¾ )
        - Emotional depth and engagement
        
        Generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        Workflow: ${{ github.workflow }}
        Run ID: ${{ github.run_id }}" || echo "No new stories to commit"

    - name: ğŸš€ Push Generated Content
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: main
        force: false

    - name: ğŸ“Š Upload Story Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: generated-stories-${{ matrix.story_type }}
        path: |
          frontend/src/data/stories/
          docs/stories/
          logs/story-generation.log
        retention-days: 30

    - name: ğŸ”” Notify Story Generation Complete
      if: success()
      run: |
        echo "âœ… Successfully generated ${{ matrix.story_type }} stories!"
        echo "ğŸ“Š Check the repository for new story content"
        echo "ğŸ® Stories are ready for game integration"

  consolidate-stories:
    needs: generate-llm-stories
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ® Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“š Consolidate All Stories
      run: |
        python scripts/story_consolidator.py \
          --merge-all-types \
          --create-master-index \
          --generate-story-map \
          --update-game-data

    - name: ğŸ¯ Create Story Release
      run: |
        python scripts/create_story_release.py \
          --version "$(date +%Y.%m.%d.%H%M)" \
          --create-changelog \
          --package-stories

    - name: ğŸ“¤ Final Commit
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Story Consolidator"
        
        git add .
        git commit -m "ğŸ­ Consolidate LLM-generated story collection

        ğŸ“Š Story Collection Summary:
        - Total Stories: $(find frontend/src/data/stories/ -name "*.json" | wc -l)
        - Story Types: $(ls frontend/src/data/stories/ | wc -l)
        - Characters: $(find frontend/src/data/characters/ -name "*.json" | wc -l)
        - Plots: $(find frontend/src/data/plots/ -name "*.json" | wc -l)
        
        ğŸ® Ready for Game Integration:
        - Master story index updated
        - Story connections mapped
        - Game data synchronized
        - Quality assurance passed
        
        Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" || echo "No consolidation needed"

    - name: ğŸš€ Push Consolidated Stories
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: main
